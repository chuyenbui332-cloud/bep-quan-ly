<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>C√¥ng th·ª©c - Qu·∫£n l√Ω b·∫øp</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* autocomplete small styles (position relative cƒÉn theo container) */
    .autocomplete-suggestions { border:1px solid #ddd; background:#fff; position:absolute; z-index:1000; max-height:160px; overflow:auto; width:100%; }
    .autocomplete-suggestions div { padding:8px; cursor:pointer; }
    .autocomplete-suggestions div:hover { background:#f3f6ff; }
    .field-row { position:relative; margin-bottom:12px; }
    form#recipeForm, form#ingredientForm { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    form label { display:block; font-size:13px; color:#444; width:100%; }
    input[type="text"], select, input[type="number"] { padding:8px 10px; border:1px solid #ccc; border-radius:6px; min-width:160px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìñ Qu·∫£n l√Ω C√¥ng th·ª©c</h1>
    <a href="index.html" class="btn btn-back">‚Üê V·ªÅ trang ch·ªß</a>

    <!-- T√¨m m√≥n (autocomplete) -->
    <div style="margin-top:18px;">
      <label>T√¨m/T·∫°o m√≥n (g√µ ƒë·ªÉ g·ª£i √Ω)</label>
      <div class="field-row" style="max-width:600px;">
        <input type="text" id="tenmon" placeholder="Nh·∫≠p t√™n m√≥n..." autocomplete="off">
        <div id="mon_suggestions" class="autocomplete-suggestions" style="display:none;"></div>
      </div>
    </div>

    <h3 style="margin-top:10px">C√¥ng th·ª©c c·ªßa: <strong id="mon_selected">‚Äî</strong></h3>

    <table>
      <thead>
        <tr>
          <th>ID NL</th>
          <th>Nguy√™n li·ªáu</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>ƒê∆°n v·ªã</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="recipeTable">
        <!-- render -->
      </tbody>
    </table>

    <hr style="margin:20px 0">
<h3>‚ûï Th√™m nguy√™n li·ªáu v√†o c√¥ng th·ª©c (m·ªói l·∫ßn 1 nguy√™n li·ªáu)</h3>
<form id="ingredientForm" style="display:flex; flex-direction:column; gap:12px;">

  <!-- Hidden -->
  <input type="hidden" id="idmon">

  <!-- H√†ng nh·∫≠p li·ªáu -->
  <div style="display:grid; grid-template-columns: 120px 1fr 150px 150px; gap:12px;">

    <!-- ID (readonly, t·ª± ƒëi·ªÅn khi ch·ªçn NL) -->
    <div>
      <label>ID</label>
      <input type="text" id="idnl" readonly placeholder="t·ª± ƒëi·ªÅn khi ch·ªçn nguy√™n li·ªáu">
    </div>

    <!-- T√™n nguy√™n li·ªáu -->
    <div>
      <label>Nguy√™n li·ªáu (g·ª£i √Ω)</label>
      <div class="field-row">
        <input type="text" id="tennl" placeholder="Nh·∫≠p t√™n nguy√™n li·ªáu..." autocomplete="off">
        <div id="nl_suggestions" class="autocomplete-suggestions" style="display:none;"></div>
      </div>
    </div>

    <!-- S·ªë l∆∞·ª£ng -->
    <div>
      <label>S·ªë l∆∞·ª£ng</label>
      <input type="number" id="soluong" step="0.01" placeholder="vd: 0.5" required>
    </div>

    <!-- ƒê∆°n v·ªã (readonly, t·ª± ƒëi·ªÅn) -->
    <div>
      <label>ƒê∆°n v·ªã</label>
      <input type="text" id="donvi" readonly placeholder="t·ª± ƒëi·ªÅn khi ch·ªçn nguy√™n li·ªáu">
    </div>
  </div>

  <!-- N√∫t th√™m -->
  <div style="display:flex; justify-content:flex-end;">
    <button class="btn btn-green" type="submit">‚ûï Th√™m</button>
  </div>
</form>

    
  <script>
    // danh s√°ch t·ª´ server ƒë·ªÉ g·ª£i √Ω
    let monList = [];
    let nlList = [];

    // helpers
    function showSuggestions(list, container, inputEl, onSelect) {
      container.innerHTML = '';
      const v = inputEl.value.trim().toLowerCase();
      if (!v) { container.style.display='none'; return; }
      const matches = list.filter(it => (it.tenmon || it.tennl|| '').toLowerCase().includes(v)).slice(0, 20);
      if (!matches.length) { container.style.display='none'; return; }
      matches.forEach(item => {
        const name = item.tenmon || item.tennl|| item.tenmon || '';
        const div = document.createElement('div');
        div.textContent = name;
        div.addEventListener('click', () => {
          onSelect(item);
          container.style.display = 'none';
        });
        container.appendChild(div);
      });
      container.style.display = 'block';
    }

    // l·∫•y d·ªØ li·ªáu m√≥n & nguy√™n li·ªáu
    async function loadStaticLists() {
      const [mres, nlres] = await Promise.all([
        fetch('/api/menu').then(r => r.json()),
        fetch('/api/nguyenlieu').then(r => r.json())
      ]);
      // unify keys: menu returns {id, ten, gia}, nguyenlieu returns {id, ten, donvi}
      monList = mres.map(m => ({ idmon: m.idmon, tenmon: m.tenmon }));
      nlList = nlres.map(n => ({ idnl: n.idnl, tennl: n.tennl, donvi: n.donvi }));
    }

    // event setup
    (async function init() {
      await loadStaticLists();

      const tenMon = document.getElementById('tenmon');
      const monSug = document.getElementById('mon_suggestions');
      tenMon.addEventListener('input', () => showSuggestions(monList, monSug, tenMon, item => {
        tenMon.value = item.tenmon;
        document.getElementById('idmon').value = item.idmon;
        document.getElementById('mon_selected').textContent = item.tenmon;
        loadRecipe(item.idmon);
      }));

      // click outside to hide suggestions
      document.addEventListener('click', (e)=> {
        if (!tenMon.contains(e.target) && !monSug.contains(e.target)) monSug.style.display='none';
        const tenNl = document.getElementById('tennl'), nlSug = document.getElementById('nl_suggestions');
        if (!tenNl.contains(e.target) && !nlSug.contains(e.target)) nlSug.style.display='none';
      });

      // nguy√™n li·ªáu suggestions
      const tenNl = document.getElementById('tennl');
      const nlSug = document.getElementById('nl_suggestions');
      tenNl.addEventListener('input', () => showSuggestions(nlList, nlSug, tenNl, item => {
        tenNl.value = item.tennl;
        document.getElementById('idnl') && (document.getElementById('idnl').value = item.idnl);
        document.getElementById('donvi').value = item.donvi || '';
      }));

      // submit th√™m nguy√™n li·ªáu
      document.getElementById('ingredientForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const idmon = document.getElementById('idmon').value;
        const tenmon = document.getElementById('tenmon').value;
        if (!tenmon) return alert('Ch·ªçn ho·∫∑c nh·∫≠p t√™n m√≥n tr∆∞·ªõc khi th√™m nguy√™n li·ªáu.');
        const tennl = document.getElementById('tennl').value.trim();
        const ngIdEl = document.getElementById('idnl');
        const idnl = ngIdEl ? ngIdEl.value : null;
        const soluong = document.getElementById('soluong').value;
        const donvi = document.getElementById('donvi').value;

        // build body: prefer ids if c√≥
        const body = {
          idmon: idmon || null,
          tenmon: tenmon,
          idnl: idnl || null,
          tennl: tennl,
          soluong: soluong,
          donvi: donvi
        };
        console.log("Body g·ª≠i ƒëi:", body);

        const res = await fetch('/api/congthuc', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        if (!res.ok) {
          const txt = await res.text();
          return alert('L·ªói th√™m: ' + res.status + ' ' + txt);
        }
        // refresh danh s√°ch c√¥ng th·ª©c hi·ªán t·∫°i:
        const mid = idmon || (await res.json()).idmon || null;
        // n·∫øu server tr·∫£ row m·ªõi, d√πng mon_id t·ª´ ƒë√≥
        loadRecipe(idmon || null);
        // reset only ingredient fields
        document.getElementById('tennl').value='';
        document.getElementById('soluong').value='';
        document.getElementById('donvi').value='';
      document.getElementById('idnl').value='';
      });
    })();

    // load c√¥ng th·ª©c c·ªßa 1 m√≥n (d√πng mon_id)
    async function loadRecipe(idmon) {
  if (!idmon) {
    document.getElementById('recipeTable').innerHTML = '';
    return;
  }
  const res = await fetch(`/api/congthuc/tenmon/${encodeURIComponent(idmon)}`);
  if (!res.ok) {
    console.error('Kh√¥ng load ƒë∆∞·ª£c c√¥ng th·ª©c', res.status);
    return;
  }
  const rows = await res.json();
  const tbody = document.getElementById('recipeTable');
  tbody.innerHTML = '';
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.idnl}</td>
      <td title="${r.tennl}">${r.tennl}</td>
      <td>${r.soluong}</td>
      <td>${r.donvi}</td>
      <td>
        <button class="btn btn-red" onclick="deleteRow(${r.idnl}, ${idmon})">üóë X√≥a</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

    // x√≥a d√≤ng
    async function deleteRow(idmon, idnl) {
      if (!confirm('X√°c nh·∫≠n xo√° nguy√™n li·ªáu kh·ªèi c√¥ng th·ª©c?')) return;
      const res = await fetch(`/api/congthuc/${idmon}/${idnl}`, { method:'DELETE' });
      if (!res.ok) return alert('X√≥a th·∫•t b·∫°i');
      loadRecipe(idmon);
    }
  </script>
</body>
</html>
